<?php declare(strict_types=1);

/** @var \Magento\Framework\View\Element\Template $block */
/** @var \Magento\Framework\Escaper $escaper */
/** @var \Magento\Framework\View\Helper\SecureHtmlRenderer $secureRenderer */

$sectionUrl = $escaper->escapeJs($block->getUrl('customer/section/load'));

$scriptContent = <<<SCRIPT
    (function () {
        'use strict';

        const url = '{$sectionUrl}' + '?sections=beslist-tracking-config&force_new_section_timestamp=true&_=' + Date.now();

        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin',
            cache: 'no-store'
        })
        .then(function (response) {
            if (!response.ok) { throw new Error('Section load failed: ' + response.status); }
            return response.json();
        })
        .then(function (data) {
            if (data && data['beslist-tracking-config']) {
                window.dispatchEvent(new CustomEvent('beslistTrackingConfigReady', {
                    detail: data['beslist-tracking-config']
                }));
            }
        })
        .catch(function (error) {
            console.error('Beslist Tracking: Failed to load configuration.', error);
        });
    })();
SCRIPT;
?>
<?= $secureRenderer->renderTag('script', [], $scriptContent, false) ?>
